<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Workout Timer</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

<!-- Low-level Cast Sender API -->
<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=0">
    
   

    pauseBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    resetBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    
   

    if (pauseBtn) pauseBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    if (resetBtn) resetBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    function broadcastToScreens(message) {
      for (let screen = 1; screen <= 4; screen++) {
        if (castSessions[screen]) {
          castSessions[screen].sendMessage(CAST_CHANNEL, message)
            .then(() => console.log(`[Cast] Sent to screen ${screen}:`, message))
            .catch(err => console.error(`[Cast] Failed for screen ${screen}:`, err));
        }
      }
    }

    document.getElementById('start-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'start' });
    });

    document.getElementById('pause-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    document.getElementById('reset-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });

</script>
<script>
  const CAST_CHANNEL = 'urn:x-cast:workout.channel';
  const sessions = {};
  window['__onGCastApiAvailable'] = function(isAvailable) {
    console.log('[Cast] API available =', isAvailable);
    if (!isAvailable) {
      console.warn('[Cast] Chromecast API not available');
      return;
    }
    const request = new chrome.cast.SessionRequest('0656D6B9');
    const config = new chrome.cast.ApiConfig(
      request,
      session => { console.log('[Cast] Session listener:', session); },
      availability => { console.log('[Cast] Receiver availability:', availability); }
    );
    chrome.cast.initialize(config, () => console.log('[Cast] Initialized'), console.error);
  };

  function linkScreen(screenNum) {
    chrome.cast.requestSession(
      session => {
        sessions[screenNum] = session;
        session.sendMessage(CAST_CHANNEL, { type: 'screen', screen: screenNum })
          .then(() => console.log('[Cast] Screen ID sent'))
          .catch(err => console.error('[Cast] Failed to send Screen ID:', err));
      },
      err => {
        console.error(`[Cast] Failed to link screen ${screenNum}:`, err);
        alert(`Link to screen ${screenNum} failed: ${err.message}`);
      }
    );
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Replace with your cast button IDs
    ['1', '2', '3', '4'].forEach(i => {
      const btn = document.getElementById(`cast-btn-${i}`);
      if (btn) btn.addEventListener('click', () => linkScreen(i));
    });
  });

    
  

    pauseBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    resetBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    
 

    if (pauseBtn) pauseBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    if (resetBtn) resetBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    function broadcastToScreens(message) {
      for (let screen = 1; screen <= 4; screen++) {
        if (castSessions[screen]) {
          castSessions[screen].sendMessage(CAST_CHANNEL, message)
            .then(() => console.log(`[Cast] Sent to screen ${screen}:`, message))
            .catch(err => console.error(`[Cast] Failed for screen ${screen}:`, err));
        }
      }
    }

    document.getElementById('start-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'start' });
    });

    document.getElementById('pause-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    document.getElementById('reset-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });

</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyA6eHJKlSB_3WsAnRZTe8AozwfxTsnDq08",
    authDomain: "workout-bac20.firebaseapp.com",
    databaseURL: "https://workout-bac20-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "workout-bac20",
    storageBucket: "workout-bac20.firebasestorage.app",
    messagingSenderId: "194637770015",
    appId: "1:194637770015:web:06608b0760b0276b38d42a",
    measurementId: "G-Q4G9CFLTM0"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window.db = db;

  function pushToFirebase(screenNum, payload) {
    if (!db) {
      console.warn("[Firebase] Not initialized, skipping push");
      return;
    }
    
    const dataWithTimestamp = {
      ...payload,
      timestamp: Date.now(),
      screen: screenNum
    };
    
    console.log(`[Firebase] Writing to screen-${screenNum}`, dataWithTimestamp);
    
    set(ref(db, `workouts/current/screen-${screenNum}`), dataWithTimestamp)
      .then(() => console.log(`[Firebase] Successfully wrote to screen-${screenNum}`))
      .catch((error) => console.error(`[Firebase] Push failed for screen-${screenNum}:`, error));
  }
  window.pushToFirebase = pushToFirebase;

    
    

    pauseBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    resetBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    
 

    if (pauseBtn) pauseBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    if (resetBtn) resetBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    function broadcastToScreens(message) {
      for (let screen = 1; screen <= 4; screen++) {
        if (castSessions[screen]) {
          castSessions[screen].sendMessage(CAST_CHANNEL, message)
            .then(() => console.log(`[Cast] Sent to screen ${screen}:`, message))
            .catch(err => console.error(`[Cast] Failed for screen ${screen}:`, err));
        }
      }
    }

    document.getElementById('start-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'start' });
    });

    document.getElementById('pause-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    document.getElementById('reset-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });

</script>

<style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: #eef2f5;
      color: #333;
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s ease;
    }
    .container {
      width: 90%;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }
    header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 2em;
    }
    .user-info {
      margin-top: 8px;
      font-size: 0.9em;
      opacity: 0.9;
      display: inline-block;
    }
    #switch-user-btn {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 0.8em;
      cursor: pointer;
      margin-left: 10px;
    }
    #user-select-view {
      display: none;
    }
    #user-select-view .action-btn {
      background: #2ecc71;
      color: #fff;
      margin: 5px 0;
    }
    .user-options {
      margin-top: 20px;
    }
    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      margin: 5px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .user-item span.user-name {
      cursor: pointer;
      font-weight: 600;
    }
    .add-user-form {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .add-user-form input {
      padding: 8px;
      font-size: 1em;
      border: 1px solid #ddd;
      border-radius: 4px;
      flex: 1;
    }
    #cast-button-container {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    google-cast-launcher {
      --disconnected-color: #757575;
      --connected-color: #4285f4;
      --inactive-color: #bdbdbd;
      width: 48px !important;
      height: 48px !important;
      margin: 8px;
      display: inline-block;
      min-width: 48px;
      min-height: 48px;
      cursor: pointer;
    }

    .action-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1em;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      color: #fff;
    }
    .action-btn:active {
      transform: scale(0.98);
    }
    .create-workout-btn, .start-btn, .reset-btn {
      background: #2ecc71;
    }
    .show-exercises-btn, .edit-btn, .delete-btn, .back-btn, .toggle-mode-btn {
      background: #2c3e50;
    }
    .action-btn:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .home-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    hr {
      border: 0;
      height: 1px;
      background: #ddd;
      margin: 20px 0;
    }
    .workout-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .workout-card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
    }
    .workout-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    .workout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .workout-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #2c3e50;
    }
    .workout-description {
      font-size: 0.95em;
      color: #7f8c8d;
      margin-bottom: 12px;
    }
    .workout-meta {
      font-size: 0.9em;
      color: #95a5a6;
      margin-bottom: 15px;
    }
    .workout-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .timer-view {
      display: none;
    }
    .screen-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .screen {
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      border-radius: 12px;
      min-height: 200px;
      position: relative;
      overflow: hidden;
    }
    .screen h3 {
      margin-top: 0;
      font-size: 1.2em;
      opacity: 0.9;
    }
    .exercises-container {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .exercise-wrapper {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }
    .exercise-wrapper .timer {
      font-size: 1.6em;
      font-weight: 600;
      margin-top: 4px;
    }
    .progress-container {
      width: 100%;
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
      margin-top: 5px;
      height: 8px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: #2ecc71;
      border-radius: 5px;
      transition: width 0.3s ease;
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 100;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      width: 95%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      animation: slideIn 0.4s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 1.5em;
      font-weight: 600;
      color: #2c3e50;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.8em;
      color: #7f8c8d;
      cursor: pointer;
    }
    .input-group {
      margin-bottom: 15px;
    }
    .input-group label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    .input-group input, 
    .input-group textarea, 
    .input-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1em;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }
    .modal-step {
      display: none;
    }
    #exercises-list-view {
      display: none;
    }
    #exercises-list-container {
      margin-top: 20px;
    }
    .exercise-item {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .exercise-details {
      font-size: 1em;
      font-weight: 500;
      color: #2c3e50;
    }

    .cast-controls {
      display: flex;
      gap: 12px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .cast-control-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.1);
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
    }

    .cast-status {
      font-size: 0.9em;
      min-width: 120px;
    }

    .cast-link-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }

    .cast-link-btn:hover {
      background: #3367d6;
    }

    .cast-link-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .container {
        padding: 25px;
      }
      header h1 {
        font-size: 2.2em;
      }
      .action-btn {
        font-size: 1.1em;
      }
    }
    #workout-modal .action-btn,
    #exercise-modal .action-btn {
      background: #2c3e50;
      color: #fff;
    }
</style>
</head>
<body>
  <!-- USER-SELECT VIEW -->
  <div class="container" id="user-select-view">
    <header><h1>Select User</h1></header>
    <div id="user-list-container" class="user-options"></div>
    <div class="add-user-form">
      <input type="text" id="new-user-name" placeholder="Enter user name">
      <button class="action-btn" id="add-user-btn">Add User</button>
    </div>
  </div>

  <!-- WORKOUT-LIST VIEW -->
  <div class="container" id="workout-list-view">
    <header>
      <h1>Workout Timer</h1>
      <div>
        <span class="user-info">User: <span id="current-user-name">None</span></span>
        <button id="switch-user-btn">Switch User</button>
      </div>
      <!-- Cast button lives here -->
      <div id="cast-button-container">
        <google-cast-launcher></google-cast-launcher>
      </div>
    </header>
    <div class="home-buttons">
      <button class="create-workout-btn action-btn" id="create-workout-btn">Create New Workout</button>
      <button class="show-exercises-btn action-btn" id="show-exercises-btn">Show Exercises</button>
    </div>
    <hr>
    <div class="workout-list" id="workout-list"></div>
  </div>
  
  <div class="container" id="exercises-list-view">
    <header>
      <h1>Saved Exercises</h1>
    </header>
    <div id="exercises-list-container"></div>
    <button id="back-to-home-btn" class="back-btn action-btn">Back to Home</button>
  </div>
  
  <div class="container timer-view" id="timer-view">
    <button class="back-btn action-btn" id="back-btn">← Back to Workouts</button>
    <!-- Cast controls for each screen -->
    <div id="cast-controls" class="cast-controls"></div>
    <div class="screen-container">
      <div class="screen" id="screen-1">
        <h3>Screen 1</h3>
        <div class="exercises-container"></div>
      </div>
      <div class="screen" id="screen-2">
        <h3>Screen 2</h3>
        <div class="exercises-container"></div>
      </div>
      <div class="screen" id="screen-3">
        <h3>Screen 3</h3>
        <div class="exercises-container"></div>
      </div>
      <div class="screen" id="screen-4">
        <h3>Screen 4</h3>
        <button class="toggle-mode-btn action-btn" data-screen="4">Switch to Time Display</button>
        <div class="exercises-container"></div>
      </div>
    </div>
    <div class="home-buttons">
      <button class="start-btn action-btn" id="start-btn">Start Workout</button>
      <button class="reset-btn action-btn" id="reset-btn" disabled>Reset</button>
    </div>
  </div>

  <!-- Workout Modal (Multi-Step Process) -->
  <div class="modal" id="workout-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Create New Workout</div>
        <button class="close-btn" id="close-modal">×</button>
      </div>
      <!-- Step 1: Basic Workout Info -->
      <div class="modal-step" id="step-1">
        <div class="input-group">
          <label for="workout-name">Workout Name</label>
          <input id="workout-name" placeholder="e.g., Full Body Routine" type="text"/>
        </div>
        <div class="input-group">
          <label for="workout-description">Description (optional)</label>
          <textarea id="workout-description" placeholder="Describe your workout" rows="3"></textarea>
        </div>
      </div>
      <!-- Step 2: Add Exercises -->
      <div class="modal-step" id="step-2">
        <!-- Saved exercise selector -->
        <div class="input-group" style="margin-bottom: 15px;">
          <label for="saved-exercise-select">Choose saved exercise</label>
          <div style="display:flex;gap:10px;">
            <select id="saved-exercise-select" style="flex:2;">
              <option value="">-- Select saved exercise --</option>
            </select>
            <button class="action-btn" id="add-saved-exercise-btn" style="flex:1;" type="button">Add</button>
          </div>
        </div>
        
        <div id="exercise-fields">
          <div class="input-group exercise-field">
            <label>Exercise 1</label>
            <div style="display: flex; gap: 10px;">
              <input class="exercise-name" placeholder="Exercise name" style="flex: 2;" type="text"/>
              <input class="exercise-duration" min="1" placeholder="Duration (sec)" style="flex: 1;" type="number" value="30"/>
              <select class="exercise-screen" style="flex: 1;">
                <option value="1">Screen 1</option>
                <option value="2">Screen 2</option>
                <option value="3">Screen 3</option>
                <option value="4">Screen 4</option>
              </select>
              <button class="action-btn save-exercise-template-btn" style="margin-left:10px;">Save</button>
            </div>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="action-btn" id="add-exercise-btn">+ Add Exercise</button>
        </div>
      </div>
      
      <div class="modal-step" id="step-3">
        <div class="input-group">
          <label for="restDurationInput">Rest Duration (sec)</label>
          <input id="restDurationInput" min="1" type="number" value="15"/>
        </div>
        <div class="input-group">
          <label for="restCountInput">Number of Rests</label>
          <input id="restCountInput" min="1" type="number" value="1"/>
        </div>
        <p style="font-size: 0.9em; color: #7f8c8d;">Configure the rest periods between your exercises.</p>
      </div>
      
      <div class="modal-step" id="step-4">
        <h3>Review Your Workout</h3>
        <div id="workout-overview"></div>
      </div>
      
      <div class="modal-actions">
        <button class="action-btn cancel-btn" id="cancel-workout">Cancel</button>
        <button class="action-btn" id="back-step" style="display:none;">Back</button>
        <button class="action-btn" id="next-step">Next</button>
        <button class="action-btn save-btn" id="confirm-workout" style="display:none;">Confirm Workout</button>
      </div>
    </div>
  </div>

  <!-- Exercise Edit Modal -->
  <div class="modal" id="exercise-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Edit Exercise</div>
        <button class="close-btn" id="close-exercise-modal">×</button>
      </div>
      <div class="input-group">
        <label for="edit-exercise-name">Exercise Name</label>
        <input id="edit-exercise-name" placeholder="Exercise name" type="text"/>
      </div>
      <div class="input-group">
        <label for="edit-exercise-duration">Duration (sec)</label>
        <input id="edit-exercise-duration" min="1" type="number" value="30"/>
      </div>
      <div class="input-group">
        <label for="edit-exercise-screen">Screen</label>
        <select id="edit-exercise-screen">
          <option value="1">Screen 1</option>
          <option value="2">Screen 2</option>
          <option value="3">Screen 3</option>
          <option value="4">Screen 4</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="action-btn cancel-btn" id="cancel-edit-exercise">Cancel</button>
        <button class="action-btn save-btn" id="save-edit-exercise">Save Exercise</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // App State Variables & DOM References
  let workouts = [];
  let currentWorkout = null;
  let timers = {};
  let exerciseCount = 1;
  let editingWorkoutId = null;
  let savedExercises = [];
  let editingSavedExerciseIndex = null;
  let globalRestSettings = null;
  let currentStep = 1;
  let users = [];
  let currentUser = null;
  let screenModes = { "4": "exercises" };
  let timeIntervals = {};

  // Cast API variables
  let castContext = null;
  const CAST_CHANNEL = 'urn:x-cast:workout.channel';
  const castSessions = {1: null, 2: null, 3: null, 4: null};
  const castControlsContainer = document.getElementById('cast-controls');

  // Initialize Cast controls
  function initializeCastControls() {
    console.log('[Cast] Initializing cast controls');
    if (!castControlsContainer) return;
    
    castControlsContainer.innerHTML = '';
    for (let i = 1; i <= 4; i++) {
      const controlItem = document.createElement('div');
      controlItem.className = 'cast-control-item';

      const status = document.createElement('span');
      status.className = 'cast-status';
      status.id = `cast-status-${i}`;
      status.textContent = `Screen ${i}: Not linked`;

      const btn = document.createElement('button');
      btn.className = 'cast-link-btn';
      btn.textContent = 'Link TV';
      btn.dataset.screen = i;

      btn.addEventListener('click', async (e) => {
        const screen = parseInt(e.target.dataset.screen, 10);
        console.log(`[Cast] Attempting to link screen ${screen}`);
        
        try {
          // Get Cast context
          if (!castContext && window.cast && cast.framework) {
            castContext = cast.framework.CastContext.getInstance();
          castContext.setOptions({
            receiverApplicationId: '0656D6B9',
            autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
          });
          }
          
          if (!castContext) {
            alert('Chromecast not ready yet. Please wait a moment and try again.');
            return;
          }

          btn.disabled = true;
          btn.textContent = 'Connecting...';

          const session = await castContext.requestSession();
          console.log(`[Cast] Session established for screen ${screen}:`, session);
          
          castSessions[screen] = session;
          if (session && session.getCastDevice) {
            status.textContent = `Screen ${screen}: ${session.getCastDevice().friendlyName}`;
          } else {
            status.textContent = `Screen ${screen}: Linked`;
          }
          btn.textContent = 'Linked';
          btn.disabled = true;

          // Send screen identification message
          try {
            await session.sendMessage(CAST_CHANNEL, { 
              type: 'screen', 
              screen: screen,
              timestamp: Date.now()
            });
            console.log(`[Cast] Screen identification sent for screen ${screen}`);
          } catch (msgError) {
            console.error(`[Cast] Failed to send screen message:`, msgError);
          }

          // Handle session disconnect
          session.addUpdateListener((isAlive) => {
            if (!isAlive) {
              console.log(`[Cast] Session disconnected for screen ${screen}`);
              castSessions[screen] = null;
              status.textContent = `Screen ${screen}: Not linked`;
              btn.textContent = 'Link TV';
              btn.disabled = false;
            }
          });

        } catch (err) {
          console.error(`[Cast] Failed to establish session for screen ${screen}:`, err);
          alert(`Failed to connect to Chromecast: ${err.message}`);
          btn.textContent = 'Link TV';
          btn.disabled = false;
        }
      });

      controlItem.appendChild(status);
      controlItem.appendChild(btn);
      castControlsContainer.appendChild(controlItem);
    }
  }

  // Make function globally available
  window.initializeCastControls = initializeCastControls;

  // Send message to Cast receiver
  function sendToCast(screenNum, message) {
    if (castSessions[screenNum]) {
      try {
        castSessions[screenNum].sendMessage(CAST_CHANNEL, message);
        console.log(`[Cast] Message sent to screen ${screenNum}:`, message);
      } catch (error) {
        console.error(`[Cast] Failed to send message to screen ${screenNum}:`, error);
      }
    }
  }

  // DOM Views
  const userSelectView = document.getElementById('user-select-view');
  const workoutListView = document.getElementById('workout-list-view');
  const exercisesListView = document.getElementById('exercises-list-view');
  const timerView = document.getElementById('timer-view');
  const userListContainer = document.getElementById('user-list-container');
  const newUserNameInput = document.getElementById('new-user-name');
  const addUserBtn = document.getElementById('add-user-btn');
  const currentUserNameSpan = document.getElementById('current-user-name');
  const switchUserBtn = document.getElementById('switch-user-btn');
  const workoutList = document.getElementById('workout-list');
  const createWorkoutBtn = document.getElementById('create-workout-btn');
  const showExercisesBtn = document.getElementById('show-exercises-btn');
  const backToHomeBtn = document.getElementById('back-to-home-btn');
  const backBtn = document.getElementById('back-btn');
  const workoutModal = document.getElementById('workout-modal');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelWorkoutBtn = document.getElementById('cancel-workout');
  const backStepBtn = document.getElementById('back-step');
  const nextStepBtn = document.getElementById('next-step');
  const confirmWorkoutBtn = document.getElementById('confirm-workout');
  const addExerciseBtn = document.getElementById('add-exercise-btn');
  const exerciseFields = document.getElementById('exercise-fields');
  const workoutNameInput = document.getElementById('workout-name');
  const workoutDescriptionInput = document.getElementById('workout-description');
  const exercisesListContainer = document.getElementById('exercises-list-container');
  const workoutOverviewDiv = document.getElementById('workout-overview');
  const exerciseModal = document.getElementById('exercise-modal');
  const closeExerciseModalBtn = document.getElementById('close-exercise-modal');
  const cancelEditExerciseBtn = document.getElementById('cancel-edit-exercise');
  const saveEditExerciseBtn = document.getElementById('save-edit-exercise');
  const editExerciseNameInput = document.getElementById('edit-exercise-name');
  const editExerciseDurationInput = document.getElementById('edit-exercise-duration');
  const editExerciseScreenSelect = document.getElementById('edit-exercise-screen');

  // Utility function to clear all intervals
  function clearAllTimers() {
    Object.values(timers).forEach(timer => clearInterval(timer));
    Object.values(timeIntervals).forEach(timer => clearInterval(timer));
    timers = {};
    timeIntervals = {};
  }

  // User Management
  function loadUsersFromLocalStorage() {
    try {
      const stored = localStorage.getItem('users');
      users = stored ? JSON.parse(stored) : [];
    } catch (error) {
      console.error('Error loading users:', error);
      users = [];
    }
  }

  function saveUsersToLocalStorage() {
    try {
      localStorage.setItem('users', JSON.stringify(users));
    } catch (error) {
      console.error('Error saving users:', error);
    }
  }

  function renderUserList() {
    userListContainer.innerHTML = '';
    if (!users.length) {
      userListContainer.innerHTML = '<p>No users found. Please add a user.</p>';
      return;
    }
    users.forEach(user => {
      const userDiv = document.createElement('div');
      userDiv.className = 'user-item';
      userDiv.innerHTML = `<span class="user-name">${user.name}</span>
                            <button class="action-btn delete-user-btn" data-id="${user.id}">Delete</button>`;
      
      userDiv.querySelector('.user-name').addEventListener('click', () => selectUser(user));
      userDiv.querySelector('.delete-user-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        deleteUser(user.id);
      });
      userListContainer.appendChild(userDiv);
    });
  }

  function addUser() {
    const name = newUserNameInput.value.trim();
    if (!name) { 
      alert('Enter a valid user name.'); 
      return; 
    }
    if (users.some(u => u.name.toLowerCase() === name.toLowerCase())) {
      alert('User name already exists.');
      return;
    }
    const newUser = { id: Date.now(), name };
    users.push(newUser);
    saveUsersToLocalStorage();
    renderUserList();
    newUserNameInput.value = '';
  }

  function deleteUser(id) {
    if (confirm('Delete this user?')) {
      users = users.filter(u => u.id !== id);
      saveUsersToLocalStorage();
      renderUserList();
    }
  }

  function selectUser(user) {
    currentUser = user;
    try {
      localStorage.setItem('currentUser', JSON.stringify(user));
    } catch (error) {
      console.error('Error saving current user:', error);
    }
    currentUserNameSpan.textContent = user.name;
    userSelectView.style.display = 'none';
    workoutListView.style.display = 'block';
  }

  // Local Storage for Workouts and Exercises
  function saveWorkoutsToLocalStorage() {
    try {
      localStorage.setItem('workouts', JSON.stringify(workouts));
    } catch (error) {
      console.error('Error saving workouts:', error);
    }
  }

  function loadWorkoutsFromLocalStorage() {
    try {
      const stored = localStorage.getItem('workouts');
      if (stored) {
        workouts = JSON.parse(stored);
      } else {
        initSampleWorkouts();
      }
    } catch (error) {
      console.error('Error loading workouts:', error);
      initSampleWorkouts();
    }
  }

  function loadSavedExercises() {
    try {
      const saved = localStorage.getItem('savedExercises');
      savedExercises = saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error('Error loading saved exercises:', error);
      savedExercises = [];
    }
  }

  function saveSavedExercises() {
    try {
      localStorage.setItem('savedExercises', JSON.stringify(savedExercises));
    } catch (error) {
      console.error('Error saving exercises:', error);
    }
  }

  // Render Functions for Workouts and Exercises
  function renderWorkoutList() {
    workoutList.innerHTML = '';
    if (!workouts.length) {
      workoutList.innerHTML = '<p>No workouts created yet.</p>';
      return;
    }
    workouts.forEach(workout => {
      const card = document.createElement('div');
      card.className = 'workout-card';
      const exCount = workout.exercises.filter(ex => ex.type === 'exercise').length;
      const restCount = workout.exercises.filter(ex => ex.type === 'rest').length;
      const totalDuration = workout.exercises.reduce((sum, ex) => sum + ex.duration, 0);
      const minutes = Math.floor(totalDuration / 60);
      const seconds = totalDuration % 60;
      const durationStr = minutes ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds} sec`;
      
      card.innerHTML = `
        <div class="workout-header">
          <div class="workout-title">${workout.name}</div>
        </div>
        <div class="workout-description">${workout.description || 'No description provided'}</div>
        <div class="workout-meta">${exCount} exercises | ${restCount} rest(s) | ${durationStr} | ${workout.date}</div>
        <div class="workout-actions">
          <button class="action-btn start-btn" data-id="${workout.id}">Start</button>
          <button class="action-btn edit-btn" data-id="${workout.id}">Edit</button>
          <button class="action-btn delete-btn" data-id="${workout.id}">Delete</button>
        </div>
      `;
      workoutList.appendChild(card);
    });
    
    // Add event listeners for workout actions
    document.querySelectorAll('.start-btn').forEach(btn => {
      btn.addEventListener('click', e => startWorkout(parseInt(e.target.getAttribute('data-id'))));
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = parseInt(e.target.getAttribute('data-id'));
        if (confirm('Delete this workout?')) {
          workouts = workouts.filter(w => w.id !== id);
          saveWorkoutsToLocalStorage();
          renderWorkoutList();
        }
      });
    });
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', e => editWorkout(parseInt(e.target.getAttribute('data-id'))));
    });
  }

  function renderExercisesListPage() {
    exercisesListContainer.innerHTML = '';
    if (!savedExercises.length) {
      exercisesListContainer.innerHTML = '<p>No saved exercises.</p>';
      return;
    }
    savedExercises.forEach((ex, index) => {
      const item = document.createElement('div');
      item.className = 'exercise-item';
      item.innerHTML = `
        <div class="exercise-details">${ex.name} - ${ex.duration} sec - Screen ${ex.screen}</div>
        <div>
          <button class="action-btn edit-btn" data-index="${index}">Edit</button>
          <button class="action-btn delete-btn" data-index="${index}">Delete</button>
        </div>
      `;
      exercisesListContainer.appendChild(item);
    });
    
    document.querySelectorAll('#exercises-list-container .edit-btn').forEach(btn => {
      btn.addEventListener('click', e => openEditExerciseModal(parseInt(e.target.getAttribute('data-index'))));
    });
    document.querySelectorAll('#exercises-list-container .delete-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const idx = parseInt(e.target.getAttribute('data-index'));
        if (confirm('Delete this saved exercise?')) {
          savedExercises.splice(idx, 1);
          saveSavedExercises();
          renderExercisesListPage();
        }
      });
    });
  }

  function initSampleWorkouts() {
    workouts = [{
      id: 1,
      name: "Full Body Workout",
      description: "A complete routine to train every muscle group.",
      date: new Date().toLocaleDateString(),
      exercises: [
        { type: "exercise", name: "Pushups", duration: 30, screen: "1" },
        { type: "exercise", name: "Squats", duration: 30, screen: "1" },
        { type: "exercise", name: "Pull-ups", duration: 30, screen: "2" },
        { type: "exercise", name: "Plank", duration: 30, screen: "3" },
        { type: "rest", name: "Rest", duration: 15, screen: "all" }
      ]
    }];
    saveWorkoutsToLocalStorage();
    renderWorkoutList();
  }

  // Timer and Screen Functions
  function startWorkout(id) {
    currentWorkout = workouts.find(w => w.id === id);
    if (!currentWorkout) return;
    
    for (let i = 1; i <= 4; i++) updateScreen(i, []);
    clearAllTimers();
    
    workoutListView.style.display = 'none';
    timerView.style.display = 'block';
    startBtn.disabled = false;
    resetBtn.disabled = true;
  }

  function updateScreen(screenNum, exercisesArr) {
    // Redraw the local preview
    const screen = document.getElementById(`screen-${screenNum}`);
    const container = screen.querySelector('.exercises-container');
    container.innerHTML = '';

    if (!exercisesArr.length) {
      container.textContent = 'No content';
      // Send clear message to Cast receiver
      sendToCast(screenNum, { 
        type: 'exercise',
        payload: { name: 'Waiting for workout...', duration: 0 }
      });
      pushToFirebase(screenNum, { type: 'clear' });
      return;
    }

    exercisesArr.forEach((ex, idx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'exercise-wrapper';
      wrapper.innerHTML = `
        <div class="exercise-display">${ex.name}</div>
        <div class="timer">${formatTime(ex.remaining || ex.duration)}</div>
        <div class="progress-container">
          <div class="progress-bar" style="width:0%;"></div>
        </div>`;
      container.appendChild(wrapper);
    });

    // Send to Cast receiver
    if (exercisesArr.length > 0) {
      const firstExercise = exercisesArr[0];
      sendToCast(screenNum, {
        type: 'exercise',
        payload: {
          name: firstExercise.name,
          duration: firstExercise.duration,
          reps: firstExercise.reps || null
        }
      });
    }

    // Broadcast to Firebase with synchronization data
    const stamp = Date.now();
    const payload = {
      type: 'exercise_data',
      screen: screenNum,
      exercises: exercisesArr.map(obj => ({
        type: obj.type,
        name: obj.name,
        duration: obj.duration,
        startsAt: stamp
      })),
      timestamp: stamp
    };
    
    pushToFirebase(screenNum, payload);
  }

  async function runExerciseRound() {
    return new Promise(resolve => {
      let active = [];
      const startTime = Date.now();
      
      // First update all screens with the exercises and send start signal
      for (let i = 1; i <= 4; i++) {
        const scrExercises = currentWorkout.exercises.filter(ex => 
          ex.type === 'exercise' && ex.screen === String(i)
        );
        updateScreen(i, scrExercises);

        // Send 'start' message to receiver
        sendToCast(i, { type: 'state', payload: 'start' });
        
        // Start timers for each exercise on each screen
        scrExercises.forEach((ex, idx) => {
          active.push(new Promise(res => {
            const timerKey = `screen-${i}-${idx}`;
            let rem = ex.duration;
            
            const updateTimer = () => {
              const wrapper = document.querySelector(`#screen-${i} .exercise-wrapper:nth-child(${idx + 1})`);
              if (!wrapper) return;
              
              const timerEl = wrapper.querySelector('.timer');
              const progressBar = wrapper.querySelector('.progress-bar');
              
              // Calculate remaining time based on start time
              const elapsed = Math.floor((Date.now() - startTime) / 1000);
              rem = Math.max(0, ex.duration - elapsed);
              
              timerEl.textContent = formatTime(rem);
              const prog = ((ex.duration - rem) / ex.duration) * 100;
              progressBar.style.width = prog + '%';
              
              // Send progress to Cast receiver
              sendToCast(i, { type: 'progress', pct: prog });
              
              if (rem <= 0) {
                clearInterval(timers[timerKey]);
                delete timers[timerKey];
                res();
              }
            };
            
            // Initial update
            updateTimer();
            
            // Set interval for updates
            timers[timerKey] = setInterval(updateTimer, 200);
          }));
        });
      }
      
      Promise.all(active).then(() => {
        // Send stop signal to all Cast receivers
        for (let i = 1; i <= 4; i++) {
          sendToCast(i, { type: 'state', payload: 'stop' });
        }
        resolve();
      });
    });
  }

  function runRestPhase() {
    return new Promise(resolve => {
      for (let i = 1; i <= 4; i++) {
        updateScreen(i, [{ name: "Rest", duration: globalRestSettings.duration, remaining: globalRestSettings.duration, type: "rest" }]);
        
        // Send rest exercise to Cast receiver
        sendToCast(i, {
          type: 'exercise',
          payload: { name: 'Rest', duration: globalRestSettings.duration }
        });
        sendToCast(i, { type: 'state', payload: 'start' });
        
        let rem = globalRestSettings.duration;
        const wrapper = document.querySelector(`#screen-${i} .exercise-wrapper`);
        if (!wrapper) continue;
        
        const timerEl = wrapper.querySelector('.timer');
        const progressBar = wrapper.querySelector('.progress-bar');
        
        timers[`screen-${i}-rest`] = setInterval(() => {
          rem--;
          timerEl.textContent = formatTime(rem);
          let prog = ((globalRestSettings.duration - rem) / globalRestSettings.duration) * 100;
          progressBar.style.width = prog + '%';
          
          // Send progress to Cast receiver
          sendToCast(i, { type: 'progress', pct: prog });
          
          if (rem <= 0) {
            clearInterval(timers[`screen-${i}-rest`]);
            delete timers[`screen-${i}-rest`];
          }
        }, 1000);
      }
      
      setTimeout(() => {
        // Send stop signal after rest
        for (let i = 1; i <= 4; i++) {
          sendToCast(i, { type: 'state', payload: 'stop' });
        }
        resolve();
      }, globalRestSettings.duration * 1000);
    });
  }

  async function startFullSequence() {
    if (!currentWorkout) {
      if (workouts.length) {
        currentWorkout = workouts[0];
        console.warn('No workout selected – defaulting to the first workout in the list.');
      } else {
        alert('No workout available.');
        return;
      }
    }
    
    startBtn.disabled = true;
    resetBtn.disabled = false;
    clearAllTimers();
    
    const rounds = globalRestSettings ? globalRestSettings.count + 1 : 1;
    
    try {
      for (let round = 1; round <= rounds; round++) {
        await runExerciseRound();
        if (round < rounds && globalRestSettings) await runRestPhase();
      }
      
      for (let i = 1; i <= 4; i++) {
        document.querySelector(`#screen-${i} .exercises-container`).textContent = 'Workout Complete';
        // Send completion message to Cast receiver
        sendToCast(i, {
          type: 'exercise',
          payload: { name: 'Workout Complete!', duration: 0 }
        });
      }
    } catch (error) {
      console.error('Error during workout sequence:', error);
      alert('An error occurred during the workout. Please try again.');
    } finally {
      startBtn.disabled = false;
      resetBtn.disabled = true;
    }
  }

  function resetTimer() {
    clearAllTimers();
    
    if (currentWorkout) {
      for (let i = 1; i <= 4; i++) {
        const scrExercises = currentWorkout.exercises.filter(ex => ex.type === 'exercise' && ex.screen === String(i));
        updateScreen(i, scrExercises);
        // Send reset/stop signal to Cast receiver
        sendToCast(i, { type: 'state', payload: 'stop' });
      }
    }
    startBtn.disabled = false;
    resetBtn.disabled = true;
  }

  function formatTime(sec) {
    const mins = Math.floor(sec / 60);
    const secs = sec % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // Workout and Modal Functions
  function openModal() {
    currentStep = 1;
    showStep(currentStep);
    if (!editingWorkoutId) {
      workoutNameInput.value = '';
      workoutDescriptionInput.value = '';
      exerciseFields.innerHTML = `
        <div class="input-group exercise-field">
          <label>Exercise 1</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" class="exercise-name" placeholder="Exercise name" style="flex: 2;">
            <input type="number" class="exercise-duration" placeholder="Duration (sec)" min="1" value="30" style="flex: 1;">
            <select class="exercise-screen" style="flex: 1;">
              <option value="1">Screen 1</option>
              <option value="2">Screen 2</option>
              <option value="3">Screen 3</option>
              <option value="4">Screen 4</option>
            </select>
            <button class="action-btn save-exercise-template-btn" style="margin-left:10px;">Save</button>
          </div>
        </div>
      `;
      exerciseCount = 1;
      globalRestSettings = null;
      
      // Add event listener to the initial save button
      const saveBtn = exerciseFields.querySelector('.save-exercise-template-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          const field = saveBtn.closest('.exercise-field');
          saveExerciseTemplate(field);
        });
      }
    }
    populateSavedExerciseSelect();
    workoutModal.style.display = 'flex';
  }

  function closeModal() {
    workoutModal.style.display = 'none';
    editingWorkoutId = null;
    document.querySelector('.modal-title').textContent = "Create New Workout";
  }

  function editWorkout(id) {
    const workout = workouts.find(w => w.id === id);
    if (!workout) return;
    
    document.querySelector('.modal-title').textContent = "Edit Workout";
    workoutNameInput.value = workout.name;
    workoutDescriptionInput.value = workout.description;
    exerciseFields.innerHTML = "";
    exerciseCount = 0;
    
    workout.exercises.forEach(ex => {
      if (ex.type === 'exercise') {
        exerciseCount++;
        const field = document.createElement('div');
        field.className = 'input-group exercise-field';
        field.innerHTML = `
          <label>Exercise ${exerciseCount}</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" class="exercise-name" placeholder="Exercise name" value="${ex.name}" style="flex: 2;">
            <input type="number" class="exercise-duration" placeholder="Duration (sec)" min="1" value="${ex.duration}" style="flex: 1;">
            <select class="exercise-screen" style="flex: 1;">
              <option value="1" ${ex.screen === "1" ? "selected" : ""}>Screen 1</option>
              <option value="2" ${ex.screen === "2" ? "selected" : ""}>Screen 2</option>
              <option value="3" ${ex.screen === "3" ? "selected" : ""}>Screen 3</option>
              <option value="4" ${ex.screen === "4" ? "selected" : ""}>Screen 4</option>
            </select>
            <button class="action-btn save-exercise-template-btn" style="margin-left:10px;">Save</button>
          </div>
        `;
        exerciseFields.appendChild(field);
        
        // Add event listener to save button
        const saveBtn = field.querySelector('.save-exercise-template-btn');
        saveBtn.addEventListener('click', () => saveExerciseTemplate(field));
      }
    });
    
    const restEx = workout.exercises.find(ex => ex.type === 'rest');
    globalRestSettings = restEx ? { duration: restEx.duration, count: workout.exercises.filter(ex => ex.type === 'rest').length } : null;
    editingWorkoutId = id;
    openModal();
  }

  function saveWorkout() {
    const name = workoutNameInput.value.trim();
    if (!name) { 
      alert('Enter a workout name'); 
      return; 
    }
    
    let exercises = [];
    document.querySelectorAll('.exercise-field').forEach(field => {
      const exName = field.querySelector('.exercise-name').value.trim();
      const duration = parseInt(field.querySelector('.exercise-duration').value);
      const screen = field.querySelector('.exercise-screen').value;
      if (exName && duration > 0) {
        exercises.push({ type: 'exercise', name: exName, duration, screen });
      }
    });
    
    if (!exercises.length) { 
      alert('Add at least one exercise'); 
      return; 
    }
    
    if (globalRestSettings) {
      for (let i = 0; i < globalRestSettings.count; i++) {
        exercises.push({ type: 'rest', name: 'Rest', duration: globalRestSettings.duration, screen: 'all' });
      }
    }
    
    if (editingWorkoutId) {
      const idx = workouts.findIndex(w => w.id === editingWorkoutId);
      if (idx >= 0) {
        workouts[idx] = {
          id: editingWorkoutId,
          name,
          description: workoutDescriptionInput.value.trim(),
          date: new Date().toLocaleDateString(),
          exercises
        };
      }
      editingWorkoutId = null;
      document.querySelector('.modal-title').textContent = "Create New Workout";
    } else {
      workouts.push({
        id: Date.now(),
        name,
        description: workoutDescriptionInput.value.trim(),
        date: new Date().toLocaleDateString(),
        exercises
      });
    }
    
    saveWorkoutsToLocalStorage();
    renderWorkoutList();
    closeModal();
  }

  function generateWorkoutOverview() {
    let overviewHTML = `<h4>${workoutNameInput.value.trim() || 'Untitled Workout'}</h4>
                        <p>${workoutDescriptionInput.value.trim() || 'No description'}</p>`;
    
    document.querySelectorAll('.exercise-field').forEach((field, idx) => {
      const exName = field.querySelector('.exercise-name').value.trim();
      const exDuration = field.querySelector('.exercise-duration').value;
      const exScreen = field.querySelector('.exercise-screen').value;
      if (exName) {
        overviewHTML += `<p><strong>Exercise ${idx+1}:</strong> ${exName} - ${exDuration} sec - Screen ${exScreen}</p>`;
      }
    });
    
    if (globalRestSettings) {
      overviewHTML += `<p><strong>Rest:</strong> ${globalRestSettings.duration} sec, repeated ${globalRestSettings.count} time(s)</p>`;
    }
    
    workoutOverviewDiv.innerHTML = overviewHTML;
  }

  function showStep(step) {
    document.querySelectorAll('.modal-step').forEach(s => s.style.display = 'none');
    document.getElementById('step-' + step).style.display = 'block';
    backStepBtn.style.display = step === 1 ? 'none' : 'inline-block';
    nextStepBtn.style.display = step === 4 ? 'none' : 'inline-block';
    confirmWorkoutBtn.style.display = step === 4 ? 'inline-block' : 'none';
  }

  // Exercise Template and Edit Modal
  function saveExerciseTemplate(field) {
    const name = field.querySelector('.exercise-name').value.trim();
    const duration = parseInt(field.querySelector('.exercise-duration').value);
    const screen = field.querySelector('.exercise-screen').value;
    
    if (!name || isNaN(duration) || duration < 1) { 
      alert('Valid exercise details required.'); 
      return; 
    }
    
    // Check if exercise already exists
    const exists = savedExercises.some(ex => 
      ex.name.toLowerCase() === name.toLowerCase() && 
      ex.duration === duration && 
      ex.screen === screen
    );
    
    if (exists) {
      alert('This exercise template already exists.');
      return;
    }
    
    savedExercises.push({ name, duration, screen });
    saveSavedExercises();
    populateSavedExerciseSelect();
    alert('Exercise template saved!');
  }

  function addExerciseField() {
    exerciseCount++;
    const div = document.createElement('div');
    div.className = 'input-group exercise-field';
    div.innerHTML = `
      <label>Exercise ${exerciseCount}</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" class="exercise-name" placeholder="Exercise name" style="flex: 2;">
        <input type="number" class="exercise-duration" placeholder="Duration (sec)" min="1" value="30" style="flex: 1;">
        <select class="exercise-screen" style="flex: 1;">
          <option value="1">Screen 1</option>
          <option value="2">Screen 2</option>
          <option value="3">Screen 3</option>
          <option value="4">Screen 4</option>
        </select>
        <button class="action-btn save-exercise-template-btn" style="margin-left:10px;">Save</button>
      </div>
    `;
    exerciseFields.appendChild(div);
    
    // Add event listener to the new save button
    const saveBtn = div.querySelector('.save-exercise-template-btn');
    saveBtn.addEventListener('click', () => saveExerciseTemplate(div));
  }

  function openEditExerciseModal(index) {
    editingSavedExerciseIndex = index;
    const ex = savedExercises[index];
    editExerciseNameInput.value = ex.name;
    editExerciseDurationInput.value = ex.duration;
    editExerciseScreenSelect.value = ex.screen;
    exerciseModal.style.display = 'flex';
  }

  // Populate saved exercise dropdown
  function populateSavedExerciseSelect() {
    const select = document.getElementById('saved-exercise-select');
    select.innerHTML = `<option value="">-- Select saved exercise --</option>`;
    savedExercises.forEach((ex, idx) => {
      select.innerHTML += `<option value="${idx}">${ex.name} - ${ex.duration} sec - Screen ${ex.screen}</option>`;
    });
  }

  // Add saved exercise into fields
  function addSavedExercise() {
    const idx = document.getElementById('saved-exercise-select').value;
    if (idx === "") return;
    
    const ex = savedExercises[idx];
    exerciseCount++;
    const div = document.createElement('div');
    div.className = 'input-group exercise-field';
    div.innerHTML = `
      <label>Exercise ${exerciseCount}</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" class="exercise-name" placeholder="Exercise name" value="${ex.name}" style="flex: 2;">
        <input type="number" class="exercise-duration" placeholder="Duration (sec)" min="1" value="${ex.duration}" style="flex: 1;">
        <select class="exercise-screen" style="flex: 1;">
          <option value="1" ${ex.screen == "1" ? "selected" : ""}>Screen 1</option>
          <option value="2" ${ex.screen == "2" ? "selected" : ""}>Screen 2</option>
          <option value="3" ${ex.screen == "3" ? "selected" : ""}>Screen 3</option>
          <option value="4" ${ex.screen == "4" ? "selected" : ""}>Screen 4</option>
        </select>
        <button class="action-btn save-exercise-template-btn" style="margin-left:10px;">Save</button>
      </div>
    `;
    exerciseFields.appendChild(div);
    
    // Add event listener to save button
    const saveBtn = div.querySelector('.save-exercise-template-btn');
    saveBtn.addEventListener('click', () => saveExerciseTemplate(div));
  }

  // Toggle Time Display for Screen 4
  function startTimeDisplay(screenId) {
    const container = document.querySelector(`#screen-${screenId} .exercises-container`);
    timeIntervals[screenId] = setInterval(() => {
      const now = new Date();
      container.innerHTML = `<div style="font-size: 48px; text-align: center;">${now.toLocaleTimeString()}</div>`;
    }, 1000);
  }

  function stopTimeDisplay(screenId) {
    if (timeIntervals[screenId]) { 
      clearInterval(timeIntervals[screenId]); 
      delete timeIntervals[screenId]; 
    }
  }

  // Event Listeners
  switchUserBtn.addEventListener('click', () => {
    workoutListView.style.display = 'none';
    userSelectView.style.display = 'block';
  });

  addUserBtn.addEventListener('click', addUser);
  
  newUserNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addUser();
  });

  createWorkoutBtn.addEventListener('click', openModal);
  
  showExercisesBtn.addEventListener('click', () => {
    workoutListView.style.display = 'none';
    exercisesListView.style.display = 'block';
    renderExercisesListPage();
  });

  backToHomeBtn.addEventListener('click', () => {
    exercisesListView.style.display = 'none';
    workoutListView.style.display = 'block';
  });

  closeModalBtn.addEventListener('click', closeModal);
  cancelWorkoutBtn.addEventListener('click', closeModal);
  addExerciseBtn.addEventListener('click', addExerciseField);

  backBtn.addEventListener('click', () => {
    timerView.style.display = 'none';
    workoutListView.style.display = 'block';
    resetTimer();
  });

  startBtn.addEventListener('click', startFullSequence);
  resetBtn.addEventListener('click', resetTimer);

  // Modal step navigation
  nextStepBtn.addEventListener('click', () => {
    if (currentStep === 1) {
      if (!workoutNameInput.value.trim()) { 
        alert('Workout name required.'); 
        return; 
      }
      currentStep = 2;
      showStep(currentStep);
    } else if (currentStep === 2) {
      const hasExercises = Array.from(document.querySelectorAll('.exercise-field')).some(field => {
        return field.querySelector('.exercise-name').value.trim();
      });
      if (!hasExercises) { 
        alert('Add at least one exercise.'); 
        return; 
      }
      currentStep = 3;
      showStep(currentStep);
    } else if (currentStep === 3) {
      const restDur = parseInt(document.getElementById('restDurationInput').value);
      const restCt = parseInt(document.getElementById('restCountInput').value);
      if (restDur < 1 || restCt < 1) { 
        alert('Valid rest settings required.'); 
        return; 
      }
      globalRestSettings = { duration: restDur, count: restCt };
      currentStep = 4;
      generateWorkoutOverview();
      showStep(currentStep);
    }
  });

  backStepBtn.addEventListener('click', () => {
    if (currentStep > 1) { 
      currentStep--; 
      showStep(currentStep); 
    }
  });

  confirmWorkoutBtn.addEventListener('click', saveWorkout);

  // Exercise modal events
  closeExerciseModalBtn.addEventListener('click', () => { 
    exerciseModal.style.display = 'none'; 
    editingSavedExerciseIndex = null; 
  });

  cancelEditExerciseBtn.addEventListener('click', () => { 
    exerciseModal.style.display = 'none'; 
    editingSavedExerciseIndex = null; 
  });

  saveEditExerciseBtn.addEventListener('click', () => {
    const name = editExerciseNameInput.value.trim();
    const duration = parseInt(editExerciseDurationInput.value);
    const screen = editExerciseScreenSelect.value;
    
    if (!name || isNaN(duration) || duration < 1) { 
      alert('Enter valid details.'); 
      return; 
    }
    
    if (editingSavedExerciseIndex !== null) {
      savedExercises[editingSavedExerciseIndex] = { name, duration, screen };
      saveSavedExercises();
      renderExercisesListPage();
      populateSavedExerciseSelect();
      exerciseModal.style.display = 'none';
      editingSavedExerciseIndex = null;
    }
  });

  // Add saved exercise button
  document.getElementById('add-saved-exercise-btn').addEventListener('click', addSavedExercise);

  // Toggle mode buttons
  document.querySelectorAll('.toggle-mode-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const screenId = this.getAttribute('data-screen');
      if (screenModes[screenId] === "exercises") {
        screenModes[screenId] = "time";
        this.textContent = "Switch to Exercise Display";
        startTimeDisplay(screenId);
      } else {
        screenModes[screenId] = "exercises";
        this.textContent = "Switch to Time Display";
        stopTimeDisplay(screenId);
        document.querySelector(`#screen-${screenId} .exercises-container`).textContent = 'No content';
      }
    });
  });

  // Initial Load
  userSelectView.style.display = 'block';
  workoutListView.style.display = 'none';
  exercisesListView.style.display = 'none';
  timerView.style.display = 'none';
  
  loadUsersFromLocalStorage();
  renderUserList();
  loadWorkoutsFromLocalStorage();
  renderWorkoutList();
  loadSavedExercises();
  
  const savedCurrentUser = localStorage.getItem('currentUser');
  if (savedCurrentUser) {
    try {
      currentUser = JSON.parse(savedCurrentUser);
      currentUserNameSpan.textContent = currentUser.name;
      userSelectView.style.display = 'none';
      workoutListView.style.display = 'block';
    } catch (error) {
      console.error('Error loading current user:', error);
    }
  }
  
  populateSavedExerciseSelect();

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    clearAllTimers();
  });

  // Initialize cast controls when DOM is ready
  setTimeout(() => {
    if (window.cast && cast.framework) {
      initializeCastControls();
    }
  }, 2000);
});

    


    pauseBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    resetBtn?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    
   

    if (pauseBtn) pauseBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    if (resetBtn) resetBtn.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });


    function broadcastToScreens(message) {
      for (let screen = 1; screen <= 4; screen++) {
        if (castSessions[screen]) {
          castSessions[screen].sendMessage(CAST_CHANNEL, message)
            .then(() => console.log(`[Cast] Sent to screen ${screen}:`, message))
            .catch(err => console.error(`[Cast] Failed for screen ${screen}:`, err));
        }
      }
    }

    document.getElementById('start-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'start' });
    });

    document.getElementById('pause-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'pause' });
    });

    document.getElementById('reset-btn')?.addEventListener('click', () => {
      broadcastToScreens({ type: 'command', action: 'reset' });
    });

</script>

<div style="margin-top: 20px;">
  <button id="start-btn">Start Workout</button>
  <button id="pause-btn">Pause Workout</button>
  <button id="reset-btn">Reset Workout</button>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
  function broadcastToScreens(message) {
    for (let screen = 1; screen <= 4; screen++) {
      if (castSessions[screen]) {
        castSessions[screen].sendMessage(CAST_CHANNEL, message)
          .then(() => console.log(`[Cast] Sent to screen ${screen}:`, message))
          .catch(err => console.error(`[Cast] Failed for screen ${screen}:`, err));
      }
    }
  }

  document.getElementById('start-btn')?.addEventListener('click', () => {
    broadcastToScreens({ type: 'command', action: 'start' });
  });

  document.getElementById('pause-btn')?.addEventListener('click', () => {
    broadcastToScreens({ type: 'command', action: 'pause' });
  });

  document.getElementById('reset-btn')?.addEventListener('click', () => {
    broadcastToScreens({ type: 'command', action: 'reset' });
  });
});
</script>

</body>
</html>
