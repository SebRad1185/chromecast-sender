<!DOCTYPE html>
<html>
<head>
  <title>Test Chromecast Sender</title>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=0"></script>
</head>
<body>
  <button onclick="linkScreen(1)">Link TV</button>

  <script>
    const CAST_APP_ID = '0656D6B9';
    const NAMESPACE = 'urn:x-cast:workout.channel';
    const sessions = {};

    window.__onGCastApiAvailable = function(isAvailable) {
      if (!isAvailable) return;
      const request = new chrome.cast.SessionRequest(CAST_APP_ID);
      const config = new chrome.cast.ApiConfig(
        request,
        session => console.log('[Cast] Session listener', session),
        availability => console.log('[Cast] Receiver availability:', availability)
      );
      chrome.cast.initialize(config, () => {
        console.log('[Cast] Initialized');
      }, console.error);
    };

    function linkScreen(screenNum) {
      chrome.cast.requestSession(
        session => {
          sessions[screenNum] = session;
          session.sendMessage(NAMESPACE, {
            type: 'screen',
            screen: screenNum
          }).then(() => {
            console.log('[Cast] Sent screen ID:', screenNum);
          }).catch(err => {
            console.error('[Cast] Failed to send screen ID:', err);
          });
        },
        err => {
          console.error('[Cast] Failed to establish session for screen', screenNum, err);
          alert('Failed to cast: ' + (err?.message || err?.errorType || err));
        }
      );
    }
  </script>
</body>
</html>
